<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Your original styles (no change) */
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        font-family: "Poppins", sans-serif;
        background: #f5f8fb;
      }
      .form-container {
        width: 100%;
        min-height: 100%;
        padding: 40px;
        box-sizing: border-box;
        background: #ffffff;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        border-radius: 12px;
        max-width: 1400px;
        margin: 20px auto;
        overflow-y: auto;
      }
      .form-container h2 {
        text-align: center;
        margin-bottom: 40px;
        color: #1a202c;
        font-size: 32px;
        font-weight: 600;
      }
      .form-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
      }
      .form-group {
        flex: 1 1 calc(33.333% - 20px);
        min-width: 250px;
        display: flex;
        flex-direction: column;
      }
      .form-group label {
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 14px;
        color: #4a5568;
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 12px;
        border: 1px solid #cbd5e0;
        border-radius: 8px;
        font-size: 14px;
        box-sizing: border-box;
        background: #f9fafb;
        transition: all 0.3s ease;
      }
      .form-group input:focus,
      .form-group select:focus {
        border-color: #3182ce;
        background: #ffffff;
        outline: none;
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.3);
      }
      .form-group input:disabled,
      .form-group select:disabled {
        background: #e2e8f0;
        color: #718096;
      }
      .hybrid-input {
        display: flex;
        gap: 10px;
      }
      .hybrid-input select {
        flex: 1;
      }
      .hybrid-input input {
        flex: 2;
      }
      .submit-container {
        text-align: center;
        margin-top: 40px;
      }
      .submit-button {
        background: linear-gradient(135deg, #3182ce, #63b3ed);
        color: #fff;
        border: none;
        padding: 14px 32px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 6px 12px rgba(49, 130, 206, 0.3);
        transition: all 0.3s ease;
      }
      .submit-button:hover {
        background: linear-gradient(135deg, #2b6cb0, #4299e1);
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(49, 130, 206, 0.4);
      }
      @media (max-width: 1000px) {
        .form-group {
          flex: 1 1 calc(50% - 20px);
        }
      }
      @media (max-width: 600px) {
        .form-group {
          flex: 1 1 100%;
        }
        .hybrid-input {
          flex-direction: column;
        }
      }
    </style>
  </head>

  <body>
    <div class="form-container">
      <h2>Student Form</h2>
      <div class="form-grid">
        <!-- All form fields -->
        <div class="form-group">
          <label>School Name</label><input id="schoolName" disabled />
        </div>
        <div class="form-group">
          <label>Student Name *</label><input id="studentName" required />
        </div>
        <div class="form-group">
          <label>Address</label><input id="address" />
        </div>
        <div class="form-group"><label>City</label><input id="city" /></div>
        <div class="form-group">
          <label>Father Name</label><input id="fatherName" />
        </div>
        <div class="form-group">
          <label>Mother Name</label><input id="motherName" />
        </div>
        <div class="form-group">
          <label>Gender</label>
          <select id="gender">
            <option value="">Select Gender</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Transgender">Transgender</option>
          </select>
        </div>
        <div class="form-group">
          <label>Date of Birth*</label><input id="dob" type="date" required/>
        </div>
        <div class="form-group">
          <label>Mobile No</label><input id="mobile" type="number" min="0" />
        </div>

        <!-- Academic Year Dropdown -->
        <div class="form-group">
          <label>Academic Year</label>
          <select id="academicyear">
            <option value="">Select Academic Year</option>
          </select>
        </div>

        <div class="form-group">
          <label>Secondary Contact</label
          ><input id="secondaryContact" type="number" min="0" />
        </div>
        <div class="form-group">
          <label>Email Address</label><input id="email" type="email" />
        </div>
        <div class="form-group">
          <label>Date Joining</label><input id="dateJoining" type="date" />
        </div>
        <div class="form-group">
          <label>Admission No</label><input id="admissionNo" />
        </div>
        <div class="form-group">
          <label>Board Type</label>
          <select id="boardType">
            <option value="CBSE">CBSE</option>
            <option value="State">State</option>
            <option value="ICSE">ICSE</option>
          </select>
        </div>
        <div class="form-group"><label>Bus No</label><input id="busNo" /></div>
        <div class="form-group">
          <label>Bus Stop</label><input id="busStop" />
        </div>
        <div class="form-group">
          <label>Student Type</label>
          <select id="studentType">
        <option value="SELECT">Select</option>
        <option value="Dayscholor">Dayscholor</option>
        <option value="Hosteller">Hosteller</option>   
      </select>
        </div>
        <div class="form-group">
          <label>Class *</label>
          <select id="classSelect">
        <option value="SELECT">Select</option>
        <option value="LKG">LKG</option>
        <option value="UKG">UKG</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
      </select>
        </div>
        <div class="form-group">
          <label>Section</label>
          <div class="hybrid-input">
            <select id="sectionDropdown" disabled>
              <option value="">Select</option>
            </select>
            <input id="sectionInput" placeholder="Or enter custom" disabled />
          </div>
        </div>
        <div class="form-group">
          <label>Aadhar Card No</label><input id="aadhar" />
        </div>
        <div class="form-group">
          <label>Apaar Card</label><input id="apaar" />
        </div>
        <div class="form-group"><label>Pen No</label><input id="penNo" /></div>

        <!-- Fee fields -->
        <div class="form-group">
          <label>Registration Fee</label
          ><input id="registrationFee" type="number" min="0" />
        </div>
        <div class="form-group">
          <label>Admission Fee</label
          ><input id="admissionFee" type="number" min="0" />
        </div>
        <div class="form-group">
          <label>Annual Fee</label
          ><input id="annualFee" type="number" min="0" />
        </div>
        <div class="form-group">
          <label>Tuition Fee Term1</label
          ><input id="tuition1" type="number" min="0" />
        </div>
        <div class="form-group">
          <label>Tuition Fee Term2</label
          ><input id="tuition2" type="number" min="0" />
        </div>
        <div class="form-group">
          <label>Tuition Fee Term3</label
          ><input id="tuition3" type="number" min="0" />
        </div>
        <div class="form-group">
          <label>Bus Fee Term1</label
          ><input id="busFee1" type="number" min="0" />
        </div>
        <div class="form-group">
          <label>Bus Fee Term2</label
          ><input id="busFee2" type="number" min="0" />
        </div>
        <div class="form-group">
          <label>Bus Fee Term3</label
          ><input id="busFee3" type="number" min="0" />
        </div>
        <div class="form-group">
          <label>Caution Deposit</label
          ><input id="cautionDeposit" type="number" min="0" />
        </div>
        <div class="form-group">
          <label>Food Fee</label><input id="foodFee" type="number" min="0" />
        </div>
        <div class="form-group">
          <label>Miscellaneous Fee</label
          ><input id="miscFee" type="number" min="0" />
        </div>
        <div class="form-group">
          <label>Total Fee</label><input id="totalFee" type="number" min="0" />
        </div>
    <!--    <div class="form-group">
          <label>Discount</label><input id="discount" type="number" min="0" />
        </div>   -->
        <div class="form-group">
          <label>Discount Narration</label
          ><input id="discountNarration" type="text" />
        </div>
      </div>

      <div class="submit-container">
        <button id="submitButton" class="submit-button">Submit</button>
      </div>
    </div>

    <script>


     window.addEventListener("message", function(event) {
  const data = event.data || {};
  console.log("Received message:", data);

  // ✅ Load student data into form
  if (data.action === "loadStudents") {
    document.getElementById("studentName").value = data.studentname || "";
    document.getElementById("address").value = data.address || "";
    document.getElementById("city").value = data.city || "";
    document.getElementById("fatherName").value = data.fathername || "";
    document.getElementById("motherName").value = data.mothername || "";
    document.getElementById("gender").value = data.gender || "";
    document.getElementById("dob").value = data.dob || "";
    document.getElementById("mobile").value = data.moblieno || "";
    document.getElementById("secondaryContact").value = data.smoblieno || "";
    document.getElementById("email").value = data.email || "";
    document.getElementById("dateJoining").value = data.datejoining || "";
    document.getElementById("admissionNo").value = data.admissionno || "";
    document.getElementById("boardType").value = data.boardtype || "";
    document.getElementById("busNo").value = data.busno || "";
    document.getElementById("busStop").value = data.busstop || "";
    document.getElementById("classSelect").value = data.studentclass || "";
    document.getElementById("sectionDropdown").value = data.section || "";
    document.getElementById("sectionInput").value = data.section || "";
    document.getElementById("aadhar").value = data.aadharcardno || "";
    document.getElementById("apaar").value = data.apaarcard || "";
    document.getElementById("penNo").value = data.penno || "";
    document.getElementById("registrationFee").value = data.registrationfee || 0;
    document.getElementById("admissionFee").value = data.admissionfee || 0;
    document.getElementById("annualFee").value = data.annualfee || 0;
    document.getElementById("tuition1").value = data.tuitionfee || 0;
    document.getElementById("tuition2").value = data.tutionfeeterm2 || 0;
    document.getElementById("tuition3").value = data.tutionterm3 || 0;
    document.getElementById("busFee1").value = data.busfeeterm1 || 0;
    document.getElementById("busFee2").value = data.busfeeterm2 || 0;
    document.getElementById("busFee3").value = data.busfeeterm3 || 0;
    document.getElementById("cautionDeposit").value = data.cautiondeposit || 0;
    document.getElementById("foodFee").value = data.foodfee || 0;
    document.getElementById("miscFee").value = data.miscellaneousfee || 0;
    document.getElementById("totalFee").value =
      parseInt(data.registrationfee || 0) +
      parseInt(data.admissionfee || 0) +
      parseInt(data.annualfee || 0) +
      parseInt(data.tuitionfee || 0) +
      parseInt(data.tutionfeeterm2 || 0) +
      parseInt(data.tutionterm3 || 0) +
      parseInt(data.busfeeterm1 || 0) +
      parseInt(data.busfeeterm2 || 0) +
      parseInt(data.busfeeterm3 || 0) +
      parseInt(data.cautiondeposit || 0) +
      parseInt(data.foodfee || 0) +
      parseInt(data.miscellaneousfee || 0) -
      parseInt(data.discount || 0);

    //document.getElementById("discount").value = data.discount || 0;
    document.getElementById("discountNarration").value = data.discountnarration || "";
    document.getElementById("schoolName").value = data.School || "";
    document.getElementById("academicyear").value = data.academicyear || "";

    console.log("Student data populated from Wix session ✅");
  }
});






      // Academic Year Dropdown fill
      const academicYearSelect = document.getElementById("academicyear");
      const startYear = 2025;
      const numberOfYears = 10; // You can adjust how many years you want
      for (let i = 0; i < numberOfYears; i++) {
        const year1 = startYear + i;
        const year2 = year1 + 1;
        const option = document.createElement("option");
        option.value = `${year1}-${year2-2000}`;
        option.textContent = `${year1}-${year2-2000}`;
        academicYearSelect.appendChild(option);
      }

      document
        .getElementById("sectionDropdown")
        .addEventListener("change", (e) => {
          if (e.target.value)
            document.getElementById("sectionInput").value = "";
        });
      document.getElementById("sectionInput").addEventListener("input", (e) => {
        if (e.target.value)
          document.getElementById("sectionDropdown").value = "";
      });

      let SCHOOL, CLASSES, SECTIONS_MAP;
      // Add this to your message event listener in the HTML code:
      window.addEventListener("message", (evt) => {
        const d = evt.data || {};
        console.log("Received message:", d); // Add this for debugging

        // Handle school initialization
        if (d.school && d.classes && d.sectionsMap) {
          SCHOOL = d.school;
          CLASSES = d.classes;
          SECTIONS_MAP = d.sectionsMap;

          // Set school name
          const schoolInput = document.getElementById("schoolName");
          if (schoolInput) schoolInput.value = SCHOOL;

          // Populate class dropdown
          const classSelect = document.getElementById("classSelect");
          if (classSelect) {
            classSelect.innerHTML =
              '<option value="">Select Class</option>' +
              CLASSES.map((c) => `<option value="${c}">${c}</option>`).join("");
            classSelect.disabled = false;
          }

          // Disable section controls initially
          const sectionDropdown = document.getElementById("sectionDropdown");
          const sectionInput = document.getElementById("sectionInput");
          if (sectionDropdown) sectionDropdown.disabled = true;
          if (sectionInput) sectionInput.disabled = true;
        }

        // New fee data handling
        if (d.type === "feeData") {
          const fees = d.payload;
          document.getElementById("registrationFee").value =
            fees.registrationFee;
          document.getElementById("admissionFee").value = fees.admissionFee;
          document.getElementById("annualFee").value = fees.annualFee;
          document.getElementById("tuition1").value = fees.tuition1;
          document.getElementById("tuition2").value = fees.tuition2;
          document.getElementById("tuition3").value = fees.tuition3;
          document.getElementById("cautionDeposit").value = fees.cautionDeposit;
          document.getElementById("totalFee").value = fees.totalFee;

          // Calculate and set bus fees if needed
          // document.getElementById('busFee1').value = fees.busFee1;
          // etc...
        }
      });
      
      
    

      
      
      
      
      
      

      document
        .getElementById("classSelect")
        .addEventListener("change", function () {
          const cls = this.value;
          const dd = document.getElementById("sectionDropdown");
          const ip = document.getElementById("sectionInput");

          if (!cls) {
            dd.disabled = ip.disabled = true;
            dd.innerHTML = '<option value="">Select</option>';
            return;
          }

          dd.disabled = ip.disabled = false;
          const opts = SECTIONS_MAP[cls] || [];
          dd.innerHTML =
            '<option value="">Select</option>' +
            opts.map((s) => `<option value="${s}">${s}</option>`).join("");

          // Request fee data for this class
          parent.postMessage(
            {
              type: "getFeeData",
              payload: {
                school: SCHOOL,
                class: cls,
              },
            },
            "*"
          );
        });

      document
        .getElementById("submitButton")
        .addEventListener("click", async () => {
          try {
            // Create a function to safely get values
            const getValue = (id) => {
              const element = document.getElementById(id);
              return element ? element.value : "";
            };

            // Collect all form data
            const payload = {
              studentName: getValue("studentName"),
              address: getValue("address"),
              city: getValue("city"),
              fatherName: getValue("fatherName"),
              motherName: getValue("motherName"),
              gender: getValue("gender"),
              dob: getValue("dob"),
              mobile: getValue("mobile"),
              academicyear: getValue("academicyear"),
              secondaryContact: getValue("secondaryContact"),
              email: getValue("email"),
              dateJoining: getValue("dateJoining"),
              admissionNo: getValue("admissionNo"),
              boardType: getValue("boardType"),
              busNo: getValue("busNo"),
              busStop: getValue("busStop"),
              class: getValue("classSelect"),
              student_type :document.getElementById("studentType").value,
              section: getValue("sectionDropdown") || getValue("sectionInput"),
              aadhar: getValue("aadhar"),
              apaar: getValue("apaar"),
              penNo: getValue("penNo"),
              registrationFee: parseInt(getValue("registrationFee")) || 0,
              admissionFee: parseInt(getValue("admissionFee")) || 0,
              annualFee: parseInt(getValue("annualFee")) || 0,
              tuition1: parseInt(getValue("tuition1")) || 0,
              tuition2: parseInt(getValue("tuition2")) || 0,
              tuition3: parseInt(getValue("tuition3")) || 0,
              busFee1: parseInt(getValue("busFee1")) || 0,
              busFee2: parseInt(getValue("busFee2")) || 0,
              busFee3: parseInt(getValue("busFee3")) || 0,
              cautionDeposit: parseInt(getValue("cautionDeposit")) || 0,
              foodFee: parseInt(getValue("foodFee")) || 0,
              miscFee: parseInt(getValue("miscFee")) || 0,
              totalFee: parseInt(getValue("totalFee")) || 0,
              discount: parseInt(getValue("discount")) || 0,
              discountNarration: getValue("discountNarration"),
              schoolName: getValue("schoolName"),
            };

            console.log("Form payload before sending:", payload); // Debug log

            // Validate required fields
            if (!payload.studentName || !payload.class || !payload.dob) {
              alert("Please fill all required fields (Student Name,Class & DOB)");
              return;
            }

            const button = document.getElementById("submitButton");
            button.disabled = true;
           // button.textContent = "Submitting...";

            // Send to parent with proper structure
            parent.postMessage(
              {
                type: "submit",
                payload: payload, // Ensure payload is properly nested
              },
              "*"
            );
          } catch (error) {
            console.error("Submission error:", error);
            alert("An error occurred: " + error.message);
            const button = document.getElementById("submitButton");
            if (button) {
              button.disabled = false;
              button.textContent = "Submit";
            }
          }
        alert("Form submitted successfully!");
        });
    </script>
  </body>
</html>
