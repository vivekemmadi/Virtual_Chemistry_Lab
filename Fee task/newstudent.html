<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Expenditure Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f9fafb;
      color: #2d3748;
    }

    

    .dashboard, .group-dashboard {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .card {
      background-color: #f1f5f9;
      padding: 10px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      flex: 1 1 200px;
      text-align: center;
    }

    .card h3 {
      margin: 0;
      font-size: 12px;
      font-weight: 600;
      color: #4a5568;
    }

    .card p {
      margin: 8px 0 0;
      font-size: 28px;
      font-weight: bold;
      color: #2b6cb0;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    .filters input,
    .filters select {
      padding: 10px;
      border: 1px solid #cbd5e0;
      border-radius: 8px;
      font-size: 14px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #ffffff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
    }

    th {
      background-color: #e2e8f0;
      font-weight: 600;
    }

    tr:nth-child(even) {
      background-color: #f7fafc;
    }

    tr:hover {
      background-color: #ebf8ff;
    }

    .label {
      margin-top: 8px;
      font-weight: 700;
    }

    .export-buttons {
      margin-bottom: 20px;
    }

    .export-buttons button {
      padding: 10px 15px;
      margin-right: 10px;
      background-color: #2b6cb0;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }

    .export-buttons button:hover {
      background-color: #1a4f8a;
    }

    .upload button:hover {
      background-color: #1a4f8a;
    }

    .main-title {
      text-align: center;
      font-size: 26px;
      font-weight: 700;
      margin-bottom: 20px;
      background: linear-gradient(to right, #2b6cb0, #00bcd4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .action-buttons button {
      margin-right: 6px;
      padding: 4px 8px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
    }

    .approve-btn {
      background-color: #38a169;
      color: white;
      border-radius: 6px;
    }

    .reject-btn {
      background-color: #e53e3e;
      color: white;
      border-radius: 6px;
    }

    @media (max-width: 768px) {
      .filters {
        flex-direction: column;
      }

      .dashboard, .group-dashboard {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="main-title">
    <h1>Expenditure Master</h1>
  </div>

  <div class="dashboard">
    <div class="card">
      <h3>Total Expenditure</h3>
      <p id="totalAmount">â‚¹0</p>
    </div>
    <div class="card">
      <h3>Total Transactions</h3>
      <p id="totalTransactions">0</p>
    </div>
    <div class="card">
      <h3>Date Range</h3>
      <p id="dateRange">--</p>
    </div>
  </div>

  <div class="group-dashboard" id="groupCardsContainer"></div>

  <div class="filters">
    <label class="label">Start Date:</label>
    <input type="date" id="fromDate" />
    <label class="label">End Date:</label>
    <input type="date" id="toDate" />
    <select id="groupDropdown">
      <option value="Select Group Name">Select Group Name</option>
      <option value="Salary">Salary</option>
      <option value="School Infrastructure">School Infrastructure</option>
    </select>
    <select id="ledgerDropdown">
      <option value="">Select Ledger Name</option>
    </select>
  </div>

  <div class="export-buttons">
    <button onclick="generatePdf()">Generate PDF</button>
    <button onclick="generateCsv()">Generate CSV</button>
  </div>

  <div id="uploadSection" style="display: none; margin-bottom: 20px;">
    <button onclick="document.getElementById('csvInput').click()" id="upload" style="padding: 10px 15px; background-color: #2b6cb0; color: white; border: 1px solid #0a509f; border-radius: 8px; font-family: 'Playfair Display', serif; font-size: 14px; cursor: pointer;">
      Upload Salary CSV
    </button>
    <input type="file" id="csvInput" accept=".csv" style="display: none;" />
  </div>
<table id="recordTable">
    <thead>
      <tr>
        <th>S.No</th>
        <th>Group Name</th>
        <th>Ledger Name</th>
        <th>Amount Paid</th>
        <th>Payment Method</th>
        <th>Narration</th>
        <th>Transaction ID</th>
        <th>Date</th>
        <th id="actionHeader" style="display: none;">Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  

  <script>
    let allRecords = [];
    let employeerole = '';
    let SchoolName = '';
    let logoUrl = "";

    window.addEventListener("message", (event) => {
      if (event.data) {
        if (event.data.employeerole) {
          employeerole = event.data.employeerole;
        }
        if (event.data.School) {
          SchoolName = event.data.School;
          console.log("schoolName:", event.data.School);
        }

        if (event.data.records) {
          allRecords = event.data.records;
          
          applyFilters();
          renderSummaryCards();
          renderGroupCards();
        }
      }
    });

  function applyFilters() {
  const group = document.getElementById("groupDropdown").value;
  const ledger = document.getElementById("ledgerDropdown").value;
  const fromDateInput = document.getElementById("fromDate").value;
  const toDateInput = document.getElementById("toDate").value;
  
  // Convert date strings to Date objects only if they have values
  const from = fromDateInput ? new Date(fromDateInput) : null;
  const to = toDateInput ? new Date(toDateInput) : null;

  const filtered = allRecords.filter(r => {
    const inGroup = group === "Select Group Name" || !group || r["Group Name"] === group;
    const inLedger = !ledger || r["Ledger Name"] === ledger;
    
    // Handle date filtering
    let inDate = true;
    if (from || to) {
      const recordDate = new Date(r.Date);
      if (from && recordDate < from) inDate = false;
      if (to && recordDate > to) inDate = false;
    }
    
    return inGroup && inLedger && inDate;
  });

  renderTable(filtered);
  renderGroupCards();
  renderSummaryCards(filtered); // Pass filtered data to summary cards
}

    function renderTable(data) {
  const tbody = document.querySelector("#recordTable tbody");
  const theadRow = document.querySelector("#recordTable thead tr");
  const actionHeader = document.getElementById("actionHeader");
  tbody.innerHTML = "";

  const group = document.getElementById("groupDropdown").value;

  if (group === "Salary") {
    theadRow.innerHTML = `
      <th>Staff ID</th>
      <th>Employee ID</th>
      <th>Employee Name</th>
      <th>Pay date</th>
      <th>Net Pay</th>
      <th>Paid days</th>
      <th>LOP Days</th>
      <th>Gross Pay</th>
      <th>Basic</th>
      <th>HRA</th>
      <th>Other Allowance</th>
      <th>Income Tax</th>
      <th>PF</th>
      <th>Action</th>
    `;
  } 
  else if (group === "School Infrastructure") {
    theadRow.innerHTML = `
      <th>S.No</th>
      <th>Group Name</th>
      <th>Ledger Name</th>
      <th>Amount Paid</th>
      <th>Payment Method</th>
      <th>Narration</th>
      <th>Transaction ID</th>
      <th>Date</th>
      ${["Principal", "ADMIN"].includes(employeerole) ? '<th id="actionHeader">Action</th>' : ''}
    `;
  }
  else {
    // Default table headers for other groups
    theadRow.innerHTML = `
      <th>S.No</th>
      <th>Group Name</th>
      <th>Ledger Name</th>
      <th>Amount Paid</th>
      <th>Payment Method</th>
      <th>Narration</th>
      <th>Transaction ID</th>
      <th>Date</th>
      ${["Principal", "ADMIN"].includes(employeerole) ? '<th id="actionHeader">Action</th>' : ''}
    `;
  }

  data.forEach((record, index) => {
    const row = document.createElement("tr");
    const status = (record.approvalstatus || "").toLowerCase().trim();
    
    if (!status || status === "pending") {
      row.classList.add("initial-red");
    } else if (status === "rejected") {
      row.classList.add("rejected");
    } else if (status === "approved") {
      row.classList.add("approved");
    }

    if (group === "Salary") {
      row.innerHTML = `
        <td>${record["Staff Id"] || ""}</td>
        <td>${record["Emp_id"] || ""}</td>
        <td>${record["Ledger Name"] || ""}</td>
        <td>${(record["Pay date"]).split("T")[0] || ""}</td>
        <td>${record["Net pay"] || ""}</td>
        <td>${(record["Paid days"] || "")}</td>
        <td>${record["lop days"] || ""}</td>
        <td>${record["Amount Paid"] || ""}</td>
        <td>${record["Basic"] || ""}</td>
        <td>${record["hra"] || ""}</td>
        <td>${record["Other Allowance"] || ""}</td>
        <td>${record["Income tax"] || ""}</td>
        <td>${record["PF"] || ""}</td>
        <td>
          <button class="approve-btn" data-emp='${JSON.stringify(record).replace(/'/g, "&apos;")}'>
            Approve
          </button>
          <span class="status-text" id="status-${record["Emp_id"]}"></span>
          <button class="reject-btn" data-id="${record["Emp_id"]}">Reject</button>
        </td>
      `;
    } 
    else if (group === "School Infrastructure") {
      row.innerHTML = `
        <td>${index + 1}</td>
        <td>${record["Group Name"] || ""}</td>
        <td>${record["Ledger Name"] || ""}</td>
        <td>${record["Amount Paid"] || ""}</td>
        <td>${record["Payment Method"] || ""}</td>
        <td>${record["Narration"] || ""}</td>
        <td>${record["Trasactionid"] || ""}</td>
        <td>${record["Date"] || ""}</td>
        ${["Principal", "ADMIN"].includes(employeerole) ? `
          <td class="action-buttons">
            ${status === "approved" ? 'Approved' : 
              status === "rejected" ? 'Rejected' : `
              <button class="approve-btn">Approve</button>
              <button class="reject-btn">Reject</button>
            `}
          </td>
        ` : ''}
      `;
    }
    else {
      // Default row for other groups
      row.innerHTML = `
        <td>${index + 1}</td>
        <td>${record["Group Name"] || ""}</td>
        <td>${record["Ledger Name"] || ""}</td>
        <td>${record["Amount Paid"] || ""}</td>
        <td>${record["Payment Method"] || ""}</td>
        <td>${record["Narration"] || ""}</td>
        <td>${record["Trasactionid"] || ""}</td>
        <td>${record["Date"] || ""}</td>
        ${["Principal", "ADMIN"].includes(employeerole) ? `
          <td class="action-buttons">
            ${status === "approved" ? 'Approved' : 
              status === "rejected" ? 'Rejected' : `
              <button class="approve-btn">Approve</button>
              <button class="reject-btn">Reject</button>
            `}
          </td>
        ` : ''}
      `;
    }

    tbody.appendChild(row);
  });

    
 document.querySelectorAll('.reject-btn:not([data-id])').forEach(btn => {
    btn.addEventListener('click', function() {
      const row = this.closest('tr');
      const index = Array.from(tbody.children).indexOf(row);
      allRecords[index].approvalstatus = "rejected";
      postApprovalUpdate(allRecords[index]);
      row.classList.remove("initial-red", "approved");
      row.classList.add("rejected");
      this.parentElement.innerHTML = 'Rejected';
    });
  });
}




  
  
document.addEventListener("click", function (e) {
  if (e.target.classList.contains("approve-btn")) {
    const btn = e.target;
    const empData = JSON.parse(btn.getAttribute("data-emp").replace(/&apos;/g, "'"));

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const margin = 15;
    const pageW = doc.internal.pageSize.getWidth();
    let y = margin;

    doc.setFont('Helvetica', 'bold').setFontSize(17);
     doc.text(SchoolName, pageW / 2, y, { align: 'center' });
    y += 10;
    doc.setFontSize(12);
    doc.text("PAYSLIP", pageW / 2, y, { align: 'center' });
    y += 20;

    // âœ… Safe function to print text
    function addLine(label, val) {
      const value = val !== undefined && val !== null ? String(val) : "-";
      doc.setFont('Helvetica', 'bold').text(label + ":", margin, y);
      doc.setFont('Helvetica', 'normal').text(value, margin + 60, y);
      y += 7;
    }

    // ðŸ”½ Employee Details
    doc.setFont('Helvetica', 'bold').setFontSize(12);
doc.text("Employee Summary", margin, y);
y += 10;

// Define columns
const leftX = margin;
const rightBoxX = pageW / 2 + 10;
let leftY = y;
let rightY = y;
const rightX = pageW / 2 + 10;

  // Draw Rounded Box around right side summary (Paid Days, LOP Days, Net Pay)
const boxW = 65;
const boxH = 3 * 7 + 4; // 3 lines Ã— 7px + padding
doc.setDrawColor(0, 0, 0); // Optional blue
doc.setLineWidth(0.5);
doc.roundedRect(rightX - 5, rightY - 5 , boxW, boxH, 3, 3);    
    
// Left column function
function addLeft(label, val) {
  const value = val !== undefined && val !== null ? String(val) : "-";
  doc.setFont('Helvetica', 'normal').text(label + ":", leftX, leftY);
  doc.setFont('Helvetica', 'normal').text(value, leftX + 40, leftY);
  leftY += 7;
}

// Right column function
function addRight(label, val) {
  const value = val !== undefined && val !== null ? String(val) : "-";
  doc.setFont('Helvetica', 'bold').text(label + ":", rightX, rightY);
doc.setFont('Helvetica', 'normal').text(value, rightX + 35, rightY);

  rightY += 7;
}

// ðŸ‘¤ Left: Employee Info | âž• Right: Paid/Lop/Net
doc.setFontSize(10);
addLeft("Employee Name", empData["Ledger Name"]);
addRight("Paid Days", empData["Paid days"]);

addLeft("Employee ID", empData["Emp_id"]);
addRight("LOP Days", empData["lop days"]);

addLeft("Staff ID", empData["Staff Id"]);
addRight("Net Pay", "Rs. " + empData["Net pay"]);

addLeft("Pay Date", (empData["Pay date"] || "").split("T")[0]);



// Align next section
y = Math.max(leftY, rightY) + 10;

    y += 10;
    doc.setFontSize(12);
    doc.setFont('Helvetica', 'bold');
    doc.text("EARNINGS", margin, y);
    doc.text("DEDUCTIONS", pageW / 2, y);
    y += 7;

    //doc.setFont('Helvetica', 'normal');
    //doc.text("Basic: Rs" + empData["Basic"] || "0", margin, y);
    doc.setFontSize(10);
    doc.setFont('Helvetica', 'normal');

    doc.text("Income Tax: Rs.  " + empData["Income tax"] || "0", pageW / 2, y);
   // y += 7;
    doc.text("Basic:  Rs. " + empData["Basic"] || "0", margin, y);
    y+=7
    doc.text("HRA:  Rs. " + empData["hra"] || "0", margin, y);
    doc.text("PF:  Rs. " + empData["PF"] || "0", pageW / 2, y);
    y += 7;
    doc.text("Other Allowance: Rs. " + empData["Other Allowance"] || "0", margin, y);

    y += 10;
    doc.setFont('Helvetica', 'bold');
    doc.text("TOTAL NET PAYABLE: Rs. " + empData["Net pay"] || "0", margin, y);

    y += 10;
    doc.setFont('Helvetica', 'italic').setFontSize(11);
    doc.text("-- This is a system-generated document. --", margin, y);


    // âœ… Base64 console log
    const base64DataUri = doc.output('datauristring');
    console.log("Full Base64 URI:", base64DataUri);

    const rawBase64 = base64DataUri.split(',')[1];
    console.log("Raw Base64 Only:", rawBase64);
     const payload = {
        pdfBase64: rawBase64,
        employeeId: empData["Emp_id"],
        school: SchoolName
      };

      console.log("PayloadBase:", payload);

      // Send payload via POST request
      fetch("https://prod-30.centralindia.logic.azure.com:443/workflows/42235e1edcfc4a4abcffa3421c3e8024/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=tvSH-5QPFEI-TBWI-p1i943g4UbUl5SalxHwtETJ2LA ", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
    // âœ… Trigger PDF download
    const link = document.createElement("a");
    link.href = base64DataUri;
    link.download = `Payslip-${empData["Emp_id"]}.pdf`;
    link.click();

    // âœ… Show Approved
    const statusSpan = document.getElementById(`status-${empData["Emp_id"]}`);
    if (statusSpan) {
      statusSpan.textContent = "Approved";
      statusSpan.style.color = "green";
      btn.disabled = true;
    }

    // Hide buttons for the approved record
    const actionCell = btn.closest("td");
    if (actionCell) {
      actionCell.innerHTML = `<span style="color: green;">Approved</span>`;
    }
  }

  if (e.target.classList.contains("reject-btn")) {
    const btn = e.target;
    const empId = btn.getAttribute("data-id");

    

    const actionCell = btn.closest("td");
    if (actionCell) {
      actionCell.innerHTML = `<span style="color: red;">Rejected</span>`;
    }
  }
});



    function postApprovalUpdate(record) {
      const payload = {
        type: "update",
        transactionId: record["Trasactionid"] || "",
        approvalStatus: record.approvalstatus
      };

      console.log("Payload:", payload);

      fetch("https://prod-00.centralindia.logic.azure.com:443/workflows/863be60b98e94a43be063337ecd89122/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=FNzffOVKuTFWB9usGBN94VOxwKtBT705qjqMEFLvQrw", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(res => console.log("Approval updated:", res))
      .catch(err => console.error("Error updating approval:", err));
    }

    function populateLedgerDropdown(group) {
      const ledgerDropdown = document.getElementById("ledgerDropdown");
      const filtered = group ? allRecords.filter(r => r["Group Name"] === group) : allRecords;
      const ledgers = [...new Set(filtered.map(r => r["Ledger Name"]).filter(Boolean))];
      ledgerDropdown.innerHTML = `<option value="">Select Ledger Name</option>` + ledgers.map(l => `<option>${l}</option>`).join("");
    }

    function renderGroupCards() {
      const container = document.getElementById("groupCardsContainer");
      container.innerHTML = "";
      const map = new Map();
      allRecords.forEach(r => {
        if (!map.has(r["Group Name"])) map.set(r["Group Name"], []);
        map.get(r["Group Name"]).push(parseFloat(r["Amount Paid"]) || 0);
      });
      map.forEach((vals, key) => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `<h3>${key}</h3><p>â‚¹${vals.reduce((a, b) => a + b, 0).toFixed(2)}</p>`;
        container.appendChild(card);
      });
    }

    function toggleUploadButton(selectedGroup) {
      const uploadSection = document.getElementById("uploadSection");
      uploadSection.style.display = selectedGroup === "Salary" ? "block" : "none";
    }
function renderSummaryCards(filteredData) {
 
}

    document.getElementById("groupDropdown").addEventListener("change", e => {
  const selectedGroup = e.target.value;
  if (selectedGroup === "Select Group Name") {
    populateLedgerDropdown(""); // Show all ledgers when no group is selected
  } else {
    populateLedgerDropdown(selectedGroup);
  }
  applyFilters();
  toggleUploadButton(selectedGroup);
});

    document.getElementById("ledgerDropdown").addEventListener("change", applyFilters);
    document.getElementById("fromDate").addEventListener("change", applyFilters);
    document.getElementById("toDate").addEventListener("change", applyFilters);

    document.getElementById("csvInput").addEventListener("change", function (event) {
      const file = event.target.files[0];
      if (!file) return;

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          const salaryRecords = results.data.map(record => {
            // Clean and convert Gross Pay to number (e.g., "â‚¹45,600" => 45600)
            const grossPayRaw = record["Gross Pay"] || "0";
            const cleanGrossPay = parseInt(grossPayRaw.replace(/[^0-9]/g, ""), 10);

            // Return cleaned record with additional "Group Name"
            return {
              ...record,
              "Gross Pay": cleanGrossPay,
              "Group Name": "Salary"
            };
          });

          // Send each record to backend
          salaryRecords.forEach((record) => {
            const payload = {
              type: "Insert",
              SchoolName: SchoolName,
              tablename: "Salaries",
              ...record
            };
            console.log("payload121:", payload);

            fetch("https://prod-00.centralindia.logic.azure.com:443/workflows/863be60b98e94a43be063337ecd89122/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=FNzffOVKuTFWB9usGBN94VOxwKtBT705qjqMEFLvQrw", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(response => console.log("Uploaded:", response))
            .catch(err => console.error("Upload error:", err));
          });

          // Replace allRecords and re-render
          allRecords = salaryRecords;
          renderTable(allRecords);
        }
      });
    });
 
        
    function generatePdf() { /* implement if needed */ }
    function generateCsv() { /* implement if needed */ }
  </script>

</body>
</html>